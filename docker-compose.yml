version: '3'

services:

    #Centralized Log Management
    seq:
        image: datalust/seq:latest
        ports:
            - 5341:80
        environment: 
            ACCEPT_EULA: Y
        restart: unless-stopped
        volumes: 
            - ./seq-data:/data 
    
    postgresql-master:
        image: 'bitnami/postgresql:latest'
        restart: 'on-failure'
        ports:
        - '5432'
        volumes:
        - './postgresql_master_data:/bitnami/postgresql'
        - './KeyRangeGeneratorSQL/create_table.sql:/docker-entrypoint-initdb.d/create_tables.sql'
        - './KeyRangeGeneratorSQL/fill_table.sql:/docker-entrypoint-initdb.d/fill_tables.sql'
        environment:
        - POSTGRESQL_REPLICATION_MODE=master
        - POSTGRESQL_REPLICATION_USER=repl_user
        - POSTGRESQL_REPLICATION_PASSWORD=repl_password
        - POSTGRESQL_USERNAME=my_user
        - POSTGRESQL_PASSWORD=my_password
        - POSTGRESQL_DATABASE=my_database
      
    postgresql-slave:
        image: 'bitnami/postgresql:latest'
        ports:
        - '5432'
        depends_on:
        - postgresql-master
        environment:
        - POSTGRESQL_REPLICATION_MODE=slave
        - POSTGRESQL_REPLICATION_USER=repl_user
        - POSTGRESQL_REPLICATION_PASSWORD=repl_password
        - POSTGRESQL_MASTER_HOST=postgresql-master
        - POSTGRESQL_PASSWORD=my_password
        - POSTGRESQL_MASTER_PORT_NUMBER=5432  
    
    key-range-provider:
        environment:
            - "ASPNETCORE_LOG_HOST=http://seq:5341"
            - "ASPNETCORE_DB_CONN=Host=postgresql-master;Port=5432;User Id=my_user;Password=my_password;Database=my_database;Pooling=true;"
        build: ./HelloShortly.KeyManagementSolutions/HelloShortly.KMM.RestApi/
        restart: on-failure
        expose: 
            - "80"
        links:
            - seq
            - postgresql-master   
            
    #Load balancer for Key Range Service Provider
    nginx:
        image: nginx:latest
        volumes:
          - ./KeyRangeServiceLoadBalancerConfig/nginx.conf:/etc/nginx/nginx.conf:ro
        depends_on:
          - key-range-provider
        ports:
          - "4000:4000" 

    
    
    
        
    

  